% !TeX root = ./prostate.tex

\startcomponent cmp_scripts
  \product prostate

	\startJSpreamble {INITIAL} used now
		

		const PTV = [
			[
				{
					name: "PTV_PR 31x240",
					spec: { dose: 7440,fxrt: 240, fxnm: 31 },
					dvh: ["V7440 cGy", "\u2265", "95\%", "", "", "", "", "", ""],
				}
			],
			[
				{
					name: "PTV_VS 31x180",
					spec: { dose: 5580, fxrt: 180, fxnm: 31 },
					dvh: ["V5580 cGy", "\u2265", "95\%", "", "", "", "", "", ""],
				}
			],
			[
				{
					name: "PTV_VS 31x170",
					spec: { dose: 5270,fxrt: 170, fxnm: 31 },
					dvh: ["V5270 cGy", "\u2265", "95\%", "", "", "", "", "", ""],
				}
			],
			[
				{
					name: "PTV_LN+ 31x180",
					spec: { dose: 5580, fxrt: 180, fxnm: 31 },
					dvh: ["V5580 cGy", "\u2265", "95\%", "", "", "", "", "", ""],
				}
			]
		]	

		const OAR = [
			{ 
				name: "CABEZAS FEMORALES", 
				dvh: [" ", "V5000 cGy < 5\% (10\%)", "DMax < 5200 cGy"] 
			},
			{ 
				name: "RECTO", 
				dvh: [" ", "V7000 cGy < 10\% (20\%)", "V4000 cGy < 45\%", "V5300 cGy < 35\%"]        
			},
			{	
				name: "VEJIGA", 
				dvh: [" ", "V7000 cGy < 10\% (20\%)", "V6100 cGy < 53\%", "V5700 cGy < 50\%"]
			}, 
			{
				name: "BULBO", 
				dvh: [" ", "V4400 cGy < 50\%", "DMean < 5000 cGy"]
			},
			{
				name: "INTESTINO", 
				dvh: [" ", "V5000 cGy < 1 cc", "V3900 cGy < 195 cc", "V4500 cGy < 150 cc"]
			},
			{
				name: "ANO", 
				dvh: [" ", "V3100 cGy < 60\%", "V3500 cGy < 40\%"]  
			}, 
			{
				name: "PENE",
				dvh: [" ", "V3000 cGy < 1 cc"]
			},
			{
				name: "TESTICULOS",
				dvh: [" ", "V300 cGy < 0.03 cc"]
			}
		]

		const DVH = [
			{
				name: "Normo",
				orgs: [
					{ oar: 0, ops: [1, 2] },
					{ oar: 1, ops: [1] },
					{ oar: 2, ops: [1] },
					{ oar: 3, ops: [1] },
					{ oar: 4, ops: [1] },
					{ oar: 5, ops: [1] },
					{ oar: 6, ops: [1] },
					{ oar: 7, ops: [1] },
					{ oar: 8, ops: [1] }
				]
			}
		]
			
		function fHelv(num, field = this.event.target){
			field.textFont = font.Helv;
			field.textSize = num;
		}

		function setDVHops(){
			const field = this.event.target;
			field.setItems(DVH.map(item => item.name));
			field.value = " ";
			fHelv(9, field);
		}

		function resetOARdvh(){
			for (var i=0; i <= 8; i++){
				getField("df_OAR" + i + "_NAME").value = "";
				for (var j=0; j <= 2; j++){
					var field = getField("df_OAR" + i + "_DVH" + j)
					field.value = "";
					field.clearItems();
				}
			}
		}

		function resetPTVdvh(index){
			var name = "df_PTV" + index;
			getField(name + "_FXRT" ).value = "";
			getField(name + "_EQUS" ).value = "";
			getField(name + "_PROD" ).value = "";
			for (var i=0; i <= 5; i++){
				getField(name + "_ID" + i).value = "";
				getField(name + "_AC" + i).value = "";
			}
		}

		function setOARdvh(){
			resetOARdvh();
			const sField = this.event.target;
			const mode = sField.currentValueIndices;
			
			DVH[mode].orgs.forEach( (org, i) => {
				getField("df_OAR" + i + "_NAME").value = OAR[org.oar].name;
				
				for (var j=0; j <= 2; j++){
					var tField = getField("df_OAR" + i + "_DVH" + j);
					tField.setItems(OAR[org.oar].dvh);
					fHelv(7, tField);
				}				

				org.ops.forEach( (op, j) => {
					var tField = getField("df_OAR" + i + "_DVH" + j);
					tField.currentValueIndices = op;
				})
			})
		}
		

		function setPTVdvh(index){
			resetPTVdvh(index);

			// const field = getField(name + "_ZONE" + index);
			// field.setItems(PTV[index].map(item => item.name));
			// fHelv(9, field);
		}

		function setPTVops(index){
			const field = this.event.target;
			field.setItems(PTV[index].map(item => item.name));
			field.value = " ";
			fHelv(9, field);
		}


		function fMakeDate(name){
			const field = getField(name);
			const cFormat = "dd/mm/yyyy";
			field.setAction("Format", "AFDate_FormatEx(\""+cFormat+"\")");
			field.setAction("Keystroke", "AFDate_KeystrokeEx(\""+cFormat+"\")");
		}
		
		fMakeDate("df_START_DATE");
		
		// fRegOAR();

	\stopJSpreamble

\stopcomponent
