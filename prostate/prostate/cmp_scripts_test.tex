% !TeX root = ./prostate.tex

\startcomponent cmp_scripts_test
  \product prostate

	\startJSpreamble {INITIAL} used now
		
		const PTV = [
			[
				{
					name: "PTV_PR HIPO SIB 31",
					fract: ["7440 cGy", "=", "240 cGy", "\u00D7", "31 Fx"],
					ideal: ["V7440 cGy", "\u2265", "95\%"],
					acept: []
				}
			],
			[
				{
					name: "PTV_LN HIPO SIB 31",
					fract: ["5580 cGy", "=", "180 cGy", "\u00D7", "31 Fx"],
					ideal: ["V5580 cGy", "\u2265", "95\%"],
					acept: []
				}
			],
			[
				{
					name: "PTV_VS HIPO SIB 31",
					fract: ["5270 cGy", "=", "170 cGy", "\u00D7", "31 Fx"],
					ideal: ["V5270 cGy", "\u2265", "95\%"],
					acept: []
				}
			],
			[
				{
					name: "PTV_LN+ HIPO SIB 31",
					fract: ["5580 cGy", "=", "180 cGy", "\u00D7", "31 Fx"],
					ideal: ["V5580 cGy", "\u2265", "95\%"],
					acept: []
				}
			]
		]	

		const OAR = [
			{	
				name: "VEJIGA", 
				dvh: ["V7000 cGy < 10\% (20\%)", "V6100 cGy < 53\%", "V5700 cGy < 50\%"]
			},
			{ 
				name: "RECTO", 
				dvh: ["V7000 cGy < 10\% (20\%)", "V4000 cGy < 45\%", "V5300 cGy < 35\%"]        
			},
			{
				name: "ANO", 
				dvh: ["V3100 cGy < 60\%", "V3500 cGy < 40\%"]  
			}, 
			{ 
				name: "CABEZAS FEMORALES", 
				dvh: ["V5000 cGy < 5\% (10\%)", "DMax < 5200 cGy"] 
			},
			{
				name: "INTESTINO", 
				dvh: ["V5000 cGy < 1 cc", "V3900 cGy < 195 cc", "V4500 cGy < 150 cc"]
			},
			{
				name: "CANAL MEDULAR", 
				dvh: ["5000 cGy < 0.03 cc"]
			},  
			{
				name: "BULBO", 
				dvh: ["V4400 cGy < 50\%", "DMean < 5000 cGy"]
			},
			{
				name: "PENE",
				dvh: ["V3000 cGy < 1 cc"]
			},
			{
				name: "TESTICULOS",
				dvh: ["V300 cGy < 0.03 cc"]
			}
		]

		const DVH = [
			{
				name: "Normo",
				orgs: [
					{ oar: 0, ops: [0, 1, 2] },
					{ oar: 1, ops: [0, 1, 2] },
					{ oar: 2, ops: [0, 1] },
					{ oar: 3, ops: [0, 1] },
					{ oar: 4, ops: [0, 1, 2] },
					{ oar: 5, ops: [0] },
					{ oar: 6, ops: [0, 1] },
					{ oar: 7, ops: [0] },
					{ oar: 8, ops: [0] },
				]
			}
		]

		const RTX = [
			{
				name: "HIPO SIB 31: PTV",
				ptv: [0],
				dvh: 0
			},
			{
				name: "HIPO SIB 31: PTV + VS",
				ptv: [0, 0],
				dvh: 0
			},
			{
				name: "HIPO SIB 31: PTV + VS + LN",
				ptv: [0, 0, 0],
				dvh: 0
			},
			{
				name: "HIPO SIB 31: PTV + VS + LN + LN(+)",
				ptv: [0, 0, 0, 0],
				dvh: 0
			},
		]
			
		//==================================================================================================================
		function setFont(size, field = this.event.target){
			field.textFont = font.Helv;
			field.textSize = size;
		}
		
		function setField(name = this.event.target, value = "", size = 9, currentValueIndices = null){
			



			const field = (typeof name === "string")? getField(name): name;
			const fName = (typeof name === "string")? name: name.name;

			console.println("Setting field: " + fName);
			console.println("With value: " + value); + 
			console.println("With size: " + size);
			console.println("In CVI: " + currentValueIndices);
			
			
			if (Array.isArray(value)) { 
				field.setItems(value);
				field.value = "";
			} else { field.value = value}
			
			setFont(size, field);
			

			if (currentValueIndices != null) {
				if (currentValueIndices == "clear") { field.clearItems() }
				else { field.currentValueIndices = currentValueIndices }
			}
		}

		function setFocus(){
			this.event.target.setFocus();
		}
		
		function setAge(){
			const d = getField("df_BIRTH_D").value;
			const m = getField("df_BIRTH_M").value;
			const y = getField("df_BIRTH_Y").value;
			
			const date = new Date(y, m-1, d);
			const age = ~~((Date.now() - date) / (31557600000));
			
			const vd = (date.getDate() == d) && (Date.now() > d);
			const vm = date.getMonth() == m-1;
			const vy = date.getFullYear() == y;			
			
			const value = (vd && vm && vy)? String(age) + " a\u00f1os" : "Fecha Invalida";
			
			setField("df_AGE", value, 9);
		}

		function setDateFormat(){
			const field  = this.event.target
			const cFormat = "dd/mm/yyyy";
			field.setAction("Format", "AFDate_FormatEx(\""+cFormat+"\")");
			field.setAction("Keystroke", "AFDate_KeystrokeEx(\""+cFormat+"\")");
		}
		//==================================================================================================================

		//==================================================================================================================
		
		function setGleason(){
			const value = getField("df_DX_GLEASON_1").value + getField("df_DX_GLEASON_2").value;
			setField("df_DX_GLEASON_OUTPUT", value, 9);
		}
		//==================================================================================================================

		//==================================================================================================================
		function resetRTX(){
			[0, 1, 2, 3].forEach( el => {
				resetPTVdvh(el);
				setField("df_PTV" + el + "_ZONE", "", 9, "clear");
			});
			resetOARdvh();
		}

		function setRTXops(){
			setField(this.event.target, RTX.map(item => item.name), 7);
		}

		function setRTXdvh(){
			resetRTX();

			const mode = this.event.target.currentValueIndices;
			RTX[mode].ptv.forEach( (el, ind) => {
				setField("df_PTV" + ind + "_ZONE", PTV[ind][el].name, 7);
				setPTVdvh(ind, el);
			});
			setField("df_OAR_OPS", DVH[RTX[mode].dvh].name, 7);
			setOARdvh(RTX[mode].dvh);
		}
		//==================================================================================================================

		//==================================================================================================================
		function resetPTVdvh(num){
			var name = "df_PTV" + num;
			[0, 1, 2, 3, 4].forEach(el => setField(name + "_FX" + el, ""));
			[0, 1, 2, 3, 4, 5].forEach(el => { 
				setField(name + "_ID" + el, "", 7);
				setField(name + "_AC" + el, "", 7);
			});
		}

		function setPTVops(num){
			setField(this.event.target, PTV[num].map(item => item.name), 9);
		}

		function setPTVdvh(num, mode = this.event.target.currentValueIndices){
			resetPTVdvh(num);
			
			const name = "df_PTV" + num;

			PTV[num][mode].fract.forEach((val, ind) => setField(name + "_FX" + ind, val, 7));
			PTV[num][mode].ideal.forEach((val, ind) => setField(name + "_ID" + ind, val, 7));
			PTV[num][mode].acept.forEach((val, ind) => setField(name + "_AC" + ind, val, 7));
		}
		//==================================================================================================================

		//==================================================================================================================
		function resetOARdvh(){
			for (var i=0; i <= 8; i++){
				setField("df_OAR" + i + "_NAME", "", 7, 0, true);
				[0, 1, 2].forEach( el => setField("df_OAR" + i + "_DVH" + el, "", 7, "clear") );
			}
		}

		function setOARops(){
			var field = this.event.target;
			field.setItems(DVH.map(item => item.name));
			// field.value = " ";
			setFont(9, field);
		}

		function setOARdvh(mode = this.event.target.currentValueIndices){
			resetOARdvh();
			
			DVH[mode].orgs.forEach( (org, i) => {
				setField("df_OAR" + i + "_NAME", OAR.map(el => el.name), 7, org.oar);
				[0, 1, 2].forEach(el => {
					var op = (el < org.ops.length)? org.ops[el] : null; 
					setField("df_OAR" + i + "_DVH" + el, OAR[org.oar].dvh, 7, op);
				})
			})
		}
		//==================================================================================================================

		//==================================================================================================================
		function resetORGdvh(num){
			[0, 1, 2].forEach( el => setField("df_OAR" + num + "_DVH" + el, "", 7, "clear") );
		}
		
		function setORGops(){
			setField(this.event.target, OAR.map(el => el.name), 9);
		}

		function setORGdvh(num, org = this.event.target.currentValueIndices){
			resetORGdvh(num);
		
			[0, 1, 2].forEach( el => setField("df_OAR" + num + "_DVH" + el, OAR[org].dvh, 7) );
		}
		//==================================================================================================================

	\stopJSpreamble

\stopcomponent
